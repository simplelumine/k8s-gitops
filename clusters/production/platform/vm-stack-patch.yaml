apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vm-stack
  namespace: monitoring
spec:
  values:
    grafana:
      # Use the secret for Admin credentials
      admin:
        existingSecret: vm-stack-auth
        userKey: admin-user
        passwordKey: admin-password

      # Inject secret values as Environment Variables
      envFromSecret: vm-stack-auth

      # Configure Grafana.ini to use Env Vars
      grafana.ini:
        server:
          domain: monitor.simplelumine.com
          root_url: https://monitor.simplelumine.com
          serve_from_sub_path: false

        auth.github:
          enabled: true
          allow_sign_up: true
          # Read from Env Vars injected by envFromSecret
          client_id: ${GF_AUTH_GITHUB_CLIENT_ID}
          client_secret: ${GF_AUTH_GITHUB_CLIENT_SECRET}
          scopes: user:email,read:org
          auth_url: https://github.com/login/oauth/authorize
          token_url: https://github.com/login/oauth/access_token
          api_url: https://api.github.com/user
          # Replace with your GitHub Organization
          allowed_organizations: lumine-duality
          # Map GitHub Teams to Grafana Roles
          role_attribute_path: "contains(groups[*], '@lumine-duality/admins') && 'Admin' || 'Viewer'"

        auth.anonymous:
          enabled: false

    # 1. Force Kubelet to use Tailscale
    kubelet:
      vmScrape:
        spec:
          relabelConfigs:
            - sourceLabels: [__meta_kubernetes_node_annotation_tailscale_com_ip]
              regex: "(.+)"
              targetLabel: __address__
              replacement: "${1}:10250"
              action: replace

    # 2. Force Node Exporter to use Tailscale
    nodeExporter:
      vmNodeScrape:
        spec:
          relabelConfigs:
            - sourceLabels: [__meta_kubernetes_node_annotation_tailscale_com_ip]
              regex: "(.+)"
              targetLabel: __address__
              replacement: "${1}:9100"
              action: replace
