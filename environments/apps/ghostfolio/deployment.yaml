apiVersion: apps/v1
kind: Deployment
metadata:
  name: ghostfolio
  namespace: ghostfolio
  labels:
    app.kubernetes.io/name: ghostfolio
    app.kubernetes.io/component: application
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ghostfolio
      app.kubernetes.io/component: application
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ghostfolio
        app.kubernetes.io/component: application
    spec:
      initContainers:
        - name: wait-for-postgres
          image: docker.io/library/postgres:16.4-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h "$PGHOST" -p "$PGPORT" -d "$PGDATABASE" -U "$PGUSER"; do
                echo "Waiting for PostgreSQL...";
                sleep 2;
              done
          env:
            - name: PGHOST
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: host
            - name: PGPORT
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: port
            - name: PGDATABASE
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: dbname
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: password
        - name: wait-for-redis
          image: docker.io/library/redis:7.2.5-alpine
          command:
            - sh
            - -c
            - |
              until redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ping | grep -q PONG; do
                echo "Waiting for Redis...";
                sleep 2;
              done
          env:
            - name: REDIS_HOST
              value: ghostfolio-cache
            - name: REDIS_PORT
              value: "6379"
      containers:
        - name: ghostfolio
          image: docker.io/ghostfolio/ghostfolio:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 3333
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: uri
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: dbname
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ghostfolio-db-app
                  key: password
            - name: REDIS_HOST
              value: ghostfolio-cache
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              value: ""
          envFrom:
            - secretRef:
                name: ghostfolio-secrets
          resources:
            requests:
              cpu: 250m
              memory: 300Mi
            limits:
              cpu: 1000m
              memory: 800Mi
