name: Validate Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - 'environments/**'
      - 'clusters/**'
      - '.github/workflows/validate-manifests.yaml'
  # Note: Removed push trigger to avoid duplicate validation after PR merge
  # Validation happens during PR review, no need to re-run after merge

jobs:
  kustomize:
    name: Kustomize Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.x'

      - name: Validate Core Components
        run: |
          echo "üîç Validating core components..."
          for dir in environments/core/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              kustomize build "$dir" > /dev/null
            fi
          done
          echo "‚úÖ Core components validation complete"

      - name: Validate App Components
        run: |
          echo "üîç Validating app components..."
          for dir in environments/apps/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              kustomize build "$dir" > /dev/null
            fi
          done
          echo "‚úÖ App components validation complete"

      - name: Validate Cluster Configurations
        run: |
          echo "üîç Validating all cluster configurations..."
          for cluster in clusters/*/; do
            if [ -d "$cluster" ] && [ -f "$cluster/kustomization.yaml" ]; then
              echo "Validating $cluster"
              kustomize build "$cluster" > /dev/null
            fi
          done
          echo "‚úÖ Cluster configurations validation complete"

  kubeconform:
    name: Kubernetes Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.x'

      - name: Setup Kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      - name: Validate Kubernetes Resources
        run: |
          echo "üîç Validating Kubernetes resources against schemas..."

          # Validate core components (skip SOPS encrypted files)
          for dir in environments/core/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              # Build with kustomize and filter out resources with 'sops' field
              kustomize build "$dir" > /tmp/manifests.yaml
              if grep -q "sops:" /tmp/manifests.yaml; then
                echo "‚ö†Ô∏è  Skipping validation (contains SOPS encrypted resources)"
              else
                cat /tmp/manifests.yaml | kubeconform -summary -ignore-missing-schemas
              fi
            fi
          done

          # Validate app components (skip SOPS encrypted files)
          for dir in environments/apps/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              kustomize build "$dir" > /tmp/manifests.yaml
              if grep -q "sops:" /tmp/manifests.yaml; then
                echo "‚ö†Ô∏è  Skipping validation (contains SOPS encrypted resources)"
              else
                cat /tmp/manifests.yaml | kubeconform -summary -ignore-missing-schemas
              fi
            fi
          done

          echo "‚úÖ Kubernetes schema validation complete"

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: environments/ clusters/
          config_data: |
            extends: default
            ignore: |
              clusters/*/flux-system/gotk-components.yaml
              clusters/*/flux-system/gotk-sync.yaml
              clusters/*/flux-system/kustomization.yaml
              **/*.sops.yaml
            rules:
              line-length: disable
              document-start: disable
              indentation:
                spaces: 2
              comments:
                min-spaces-from-content: 1
