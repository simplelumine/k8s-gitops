name: Validate GitOps Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - 'environments/**'
      - 'clusters/**'
      - '.github/workflows/validate.yaml'
  push:
    branches: [main]
    paths:
      - 'environments/**'
      - 'clusters/**'

jobs:
  validate-kustomize:
    name: Validate Kustomize Builds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.x'

      - name: Validate Core Production
        run: |
          echo "ğŸ” Validating core production overlay..."
          kustomize build environments/core/overlays/prod

      - name: Validate Core Staging
        run: |
          echo "ğŸ” Validating core staging overlay..."
          kustomize build environments/core/overlays/staging

      - name: Validate Apps Production
        run: |
          echo "ğŸ” Validating apps production overlay..."
          kustomize build environments/apps/overlays/prod

      - name: Validate Apps Staging
        run: |
          echo "ğŸ” Validating apps staging overlay..."
          kustomize build environments/apps/overlays/staging

      - name: Validate Clusters us-west
        run: |
          echo "ğŸ” Validating clusters/us-west..."
          kustomize build clusters/us-west

      - name: Validate Clusters staging
        run: |
          echo "ğŸ” Validating clusters/staging..."
          kustomize build clusters/staging

  validate-flux:
    name: Validate Flux Resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Validate Flux Installation
        run: flux check --pre

      - name: Validate all Flux Kustomizations
        run: |
          echo "ğŸ” Validating Flux Kustomization manifests..."
          find clusters/ -name "*.yaml" -not -path "*/flux-system/*" -type f | while read file; do
            echo "Validating $file"
            kubectl apply --dry-run=client -f "$file" || exit 1
          done

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: environments/ clusters/
          config_data: |
            extends: default
            rules:
              line-length: disable
              indentation:
                spaces: 2
              comments:
                min-spaces-from-content: 1
