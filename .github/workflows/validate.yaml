name: Validate GitOps Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - 'environments/**'
      - 'clusters/**'
      - '.github/workflows/validate.yaml'
  push:
    branches: [main]
    paths:
      - 'environments/**'
      - 'clusters/**'

jobs:
  validate-kustomize:
    name: Validate Kustomize Builds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.x'

      - name: Validate Core Components
        run: |
          echo "ğŸ” Validating core components..."
          for dir in environments/core/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              kustomize build "$dir"
            fi
          done
          echo "âœ… Core components validation complete (or no components found)"

      - name: Validate App Components
        run: |
          echo "ğŸ” Validating app components..."
          for dir in environments/apps/*/; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir"
              kustomize build "$dir"
            fi
          done
          echo "âœ… App components validation complete (or no components found)"

      - name: Validate All Clusters
        run: |
          echo "ğŸ” Validating all cluster configurations..."
          for cluster in clusters/*/; do
            if [ -d "$cluster" ] && [ -f "$cluster/kustomization.yaml" ]; then
              echo "Validating $cluster"
              kustomize build "$cluster"
            fi
          done
          echo "âœ… Cluster configurations validation complete"

  validate-flux:
    name: Validate Flux Resources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Flux Kustomization YAML Syntax
        run: |
          echo "ğŸ” Validating Flux Kustomization YAML syntax..."
          find clusters/ -name "*.yaml" -not -path "*/flux-system/gotk-*" -type f | while read file; do
            echo "Checking $file"
            # ç®€å•çš„ YAML è¯­æ³•æ£€æŸ¥
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: environments/ clusters/
          config_data: |
            extends: default
            ignore: |
              clusters/*/flux-system/gotk-components.yaml
              clusters/*/flux-system/gotk-sync.yaml
              clusters/*/flux-system/kustomization.yaml
            rules:
              line-length: disable
              indentation:
                spaces: 2
              comments:
                min-spaces-from-content: 1
